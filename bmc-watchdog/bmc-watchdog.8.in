\."#############################################################################
\."$Id: bmc-watchdog.8.in,v 1.4 2004-12-08 00:57:14 chu11 Exp $
\."#############################################################################
\."  Copyright (C) 2004 The Regents of the University of California.
\."  Produced at Lawrence Livermore National Laboratory (cf, DISCLAIMER).
\."  Written by Albert Chu <chu11@llnl.gov>
\."  UCRL-CODE-155913
\."  
\."  This file is part of Bmc-Watchdog, a base management controller (BMC)
\."  watchdog timer management tool.  For details, see http://www.llnl.gov/linux/.
\."
\."  Bmc-Watchdog is free software; you can redistribute it and/or modify it under
\."  the terms of the GNU General Public License as published by the Free
\."  Software Foundation; either version 2 of the License, or (at your option)
\."  any later version.
\."  
\."  Bmc-Watchdog is distributed in the hope that it will be useful, but WITHOUT 
\."  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or 
\."  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License 
\."  for more details.
\."  
\."  You should have received a copy of the GNU General Public License along
\."  with Bmc-Watchdog; if not, write to the Free Software Foundation, Inc.,
\."  59 Temple Place, Suite 330, Boston, MA  02111-1307  USA.
\."############################################################################
.TH bmc-watchdog 8 "April 2004" "bmc-watchdog @VERSION@" "System Commands"
.SH "NAME"
bmc-watchdog \- BMC watchdog timer daemon and control utility
.SH "SYNOPSIS"
.B bmc-watchdog command [OPTIONS] [COMMAND_OPTIONS]...
.br
.SH "DESCRIPTION"
.B bmc-watchdog
controls a Baseboard Management Controller (BMC) watchdog timer.  The
.B bmc-watchdog
tool typically executes as a cronjob or daemon to manage the watchdog
timer.  A user must be root in order to run
.B bmc-watchdog. 

.SH "BMC WATCHDOG DETAILS"
A BMC watchdog timer is part of the Intelligent Platform Management
Interface (IPMI) specification and is only available to BMCs that are
compliant with IPMI.  When a BMC watchdog timer is started, it begins
counting down to zero from some positive number of seconds.  When the
timer hits zero, the timer will execute a pre-configured pre-timeout
interrupt and/or timeout action.

In order to stop the pre-timeout interrupt or timeout action from
being executed, the watchdog timer must be periodically reset back to
its initial beginning value.

The BMC watchdog timer automatically stops itself when the machine is
rebooted.  Therefore, when a machine is brought up, the BMC watchdog
timer must be setup again before it can be used.

Typically, a BMC watchdog timer is used to automatically reset a
machine that has crashed.  When the operating system first starts up,
the BMC timer is set to its initial countdown value.  At periodic
intervals, when the operating system is functioning properly, the
watchdog timer can be reset by the OS or a userspace program.  Thus,
the timer never counts down to zero.  When the system crashes, the
timer cannot be reset by the OS or userspace program.  Eventually, the
timer will countdown to zero and reset the machine.

See EXAMPLES below for examples of how bmc-watchdog is commonly used.

.SH "COMMANDS"
The following commands are available to
.B bmc-watchdog.
.TP
.B  -s, --set                       
Set BMC Watchdog Configuration.  BMC watchdog timer configuration
values can be set using the set command options listed below under SET
OPTIONS.  If a particular configuration parameter is not specified on
the command line, the current configuration of that parameter will not
be changed.
.TP
.B  -g, --get                       
Get BMC Watchdog Configuration and State.  The current
configuration and state is printed to standard output.
.TP
.B  -r, --reset                     
Reset BMC Watchdog Timer.  
.TP
.B  -t, --start                     
Start BMC Watchdog Timer.  Does nothing if the timer is currently
running.  Identical to --reset command when the timer is stopped with
the exception of the start command options listed below under START
OPTIONS.
.TP
.B  -y, --stop                      
Stop BMC Watchdog Timer.  Stops the current timer.
.TP
.B  -c, --clear                     
Clear BMC Watchdog Configuration.  Clears all configuration values
for the watchdog timer, except for timer use, which is kept at 
its current value.
.TP
.B  -d, --daemon
Run 
.B bmc-watchdog 
as a daemon.  Configurable BMC watchdog timer options are listed below
under DAEMON OPTIONS.  The configuration values are set once, then the
daemon will reset the timer at specified periodic intervals.
Everytime the BMC watchdog timer is reset, a log entry will be
generated in the bmc-watchdog log.  The default log is stored at
/var/log/freeipmi/bmc-watchdog.log.  The daemon can be stopped using
the --stop command, --clear command, or by setting the stop_timer flag
on the --set command.
.SH "OPTIONS"
The following options can be used by any command.
.TP
.B  -h, --help
Output the help menu.  If a specific command (--set, --get, --reset,
--start, --stop, --clear, or --daemon) is listed on the command
line, only the specific options for that command will be listed.
.TP
.B  -v, --version
Output the program version.
.TP
.B  -o INT, --io-port=INT
Identify the System Base Address for KCS SMS/IO.  If not specified, 
.B bmc-watchdog 
will attempt to probe for the system's default io-port.  If the probe
fails, the IPMI defined default will be used.  If the io-port number
is prefixed with a "0x", it is assumed to be a base 16 integer.
Otherwise, it is assumed to be a base 10 integer.
.TP
.B  -R INT, --reg-space=INT
Specify base address register spacing.  The register spacing value can be
set to one of the following: 0 = 1 byte, 1 = 4 bytes, 2 = 16 bytes.
If not specified,
.B bmc-watchdog 
will attempt to probe for the system's default register spacing.  If
the probe fails, the IPMI defined default will be used.
.TP
.B  -f STRING, --logfile=STRING
Specify an alternate logfile from the default of
/var/log/freeipmi/bmc-watchdog.log.
.TP
.B  -n, --no-logging
Turns off all logging done by 
.B bmc-watchdog.  
.if @WITH_DEBUG@ \{
.TP
.B  -D, --debug
Turns on debugging.  All data written and read from the BMC is dumped
to stderr.
\}
.SH "SET OPTIONS"
The following options can be used by the set command to set or clear
various BMC watchdog configuration parameters.
.TP
.B  -u INT, --timer-use=INT
Set timer use.  The timer use value can be set to one of the
following: 1 = BIOS FRB2, 2 = BIOS POST, 3 = OS_LOAD, 4 = SMS OS, 5 =
OEM.
.TP
.B  -m INT, --stop-timer=INT
Set Stop Timer Flag.  A flag value of 0 stops the current BMC watchdog
timer.  A value of 1 doesn't turn off the current watchdog timer.
.TP
.B  -l INT, --log=INT
Set Log Flag.  A flag value of 0 turns logging on.  A value of 1 turns
logging off.
.TP
.B  -a INT, --timeout-action=INT
Set timeout action.  The timeout action can be set to one of the
following: 0 = No action, 1 = Hard Reset, 2 = Power Down, 3 = Power
Cycle.
.TP
.B  -p INT, --pre-timeout-interrupt=INT
Set pre-timeout interrupt.  The pre timeout interrupt can be set to
one of the following: 0 = None, 1 = SMI, 2 = NMI, 3 = Messaging
Interrupt.
.TP
.B  -z SECS, --pre-timeout-interval=SECS  
Set pre-timeout interval in seconds.
.TP
.B  -F, --clear-bios-frb2
Clear  BIOS FRB2 Timer Use Flag.
.TP
.B  -P, --clear-bios-post
Clear BIOS POST Timer Use Flag.
.TP
.B  -L, --clear-os-load
Clear OS Load Timer Use Flag.
.TP
.B  -S, --clear-sms-os
Clear SMS/OS Timer Use Flag.
.TP
.B  -O, --clear-oem
Clear OEM Timer Use Flag.
.TP
.B  -i SECS, --initial-countdown=SECS
Set initial countdown in seconds.
.TP
.B  -w, --start-after-set
Start timer after set command if timer is stopped.  This is typically
used when
.B bmc-watchdog
is used as a cronjob.  This can be used to automatically start the
timer after it has been set the first time.
.TP
.B  -x, --reset-after-set
Reset timer after set command if timer is running.
.TP
.B  -j, --start-if-stopped
Don't execute set command if timer is stopped, just start timer.
.TP
.B  -k, --reset-if-running
Don't execute set command if timer is running, just reset timer. This
is typically used when
.B bmc-watchdog
is used as a cronjob.  This can be used to reset the timer after it
has been initially started.

.SH "START OPTIONS"
The following options can be used by the start command.
.TP
.B  -G INT, --gratuitous-arp=INT
Suspend or don't suspend gratuitous ARPs while the BMC timer is
running.  A flag value of 1 suspends gratuitous ARPs.  A value of 0
will not suspend gratuitous ARPs.  If this option is not specified,
gratuitous ARPs will not be suspended.
.TP
.B  -A INT, --arp-response=INT
Suspend or don't suspend BMC-generated ARP responses while the BMC
timer is running.  A flag value of 1 suspends ARP responses.  A value
of 0 will not suspend ARP responses.  If this option is not specified,
ARP responses will not be suspended.

.SH "DAEMON OPTIONS"
The following options can be used by the daemon command to set the
initial BMC watchdog configuration parameters.
.TP
.B  -u INT, --timer-use=INT
Set timer use.  The timer use value can be set to one of the
following: 1 = BIOS FRB2, 2 = BIOS POST, 3 = OS_LOAD, 4 = SMS OS, 5 =
OEM.
.TP
.B  -l INT, --log=INT
Set Log Flag.  A flag value of 0 turns logging on.  A value of 1 turns
logging off.
.TP
.B  -a INT, --timeout-action=INT
Set timeout action.  The timeout action can be set to one of the
following: 0 = No action, 1 = Hard Reset, 2 = Power Down, 3 = Power
Cycle.
.TP
.B  -p INT, --pre-timeout-interrupt=INT
Set pre-timeout interrupt.  The pre timeout interrupt can be set to
one of the following: 0 = None, 1 = SMI, 2 = NMI, 3 = Messaging
Interrupt.
.TP
.B  -z SECS, --pre-timeout-interval=SECS  
Set pre-timeout interval in seconds.
.TP
.B  -F, --clear-bios-frb2
Clear  BIOS FRB2 Timer Use Flag.
.TP
.B  -P, --clear-bios-post
Clear BIOS POST Timer Use Flag.
.TP
.B  -L, --clear-os-load
Clear OS Load Timer Use Flag.
.TP
.B  -S, --clear-sms-os
Clear SMS/OS Timer Use Flag.
.TP
.B  -O, --clear-oem
Clear OEM Timer Use Flag.
.TP
.B  -i SECS, --initial-countdown=SECS
Set initial countdown in seconds.
.TP
.B  -G INT, --gratuitous-arp=INT
Suspend or don't suspend gratuitous ARPs while the BMC timer is
running.  A flag value of 1 suspends gratuitous ARPs.  A value of 0
will not suspend gratuitous ARPs.  If this option is not specified,
gratuitous ARPs will not be suspended.
.TP
.B  -A INT, --arp-response=INT
Suspend or don't suspend BMC-generated ARP responses while the BMC
timer is running.  A flag value of 1 suspends ARP responses.  A value
of 0 will not suspend ARP responses.  If this option is not specified,
ARP responses will not be suspended.
.TP
.B  -e, --reset-period
Time interval to wait before resetting timer.  The default is 60
seconds.
.SH "ERRORS"
Errors are logged to the bmc-watchdog log.

.SH "EXAMPLES" 
.LP 
Setup a bmc-watchdog daemon that resets the machine after 15 minutes
(900 seconds) if the OS has crashed (see default bmc-watchdog rc
script /etc/init.d/bmc-watchdog for a more complete example):
        bmc-watchdog -d -u 4 -p 0 -a 1 -i 900

.SH "KNOWN ISSUES"
.B Bmc-watchdog
may fail to reset the watchdog timer if it is not scheduled properly.
It is always recommended that 
.B bmc-watchdog
be executed with a high scheduling priority.

On some machines, the hardware based SMI Handler may disable a
processor after a watchdog timer timeout if the timer use is set to
something other than SMS/OS.
.SH "ORIGIN"
Developed by Albert Chu <chu11@llnl.gov> on LLNL's Linux clusters.
This software is open source and distributed under the terms of the
Gnu GPL.
