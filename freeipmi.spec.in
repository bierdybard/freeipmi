#
# Copyright (c) 2003 FreeIPMI Core Team
#

%define name @PACKAGE@
%define version @VERSION@
%if %{?_with_debug:1}%{!?_with_debug:0}
%define release 1.debug
%else
%define release 1
%endif

Name: %{name}
Version: %{version}

Release: %{release}
License: GPL
Group: Development/System
Source: %{name}-%{version}.tar.gz
BuildRoot: %{_localstatedir}/tmp/%{name}-%{version}
Summary: FreeIPMI
%description
The FreeIPMI project provides "Remote-Console" (out-of-band) and
"System Management Software" (in-band) based on Intelligent
Platform Management Interface (IPMI v1.5) specification.

%package devel
Summary: Development package for FreeIPMI
Group: Development/System
Requires: freeipmi = %{version}-%{release}
%description devel
Development package for FreeIPMI.  This package includes the FreeIPMI
header files and static libraries.

%package fish
Summary: FreeIPMI Shell
Group: Application/Misc  
Requires: freeipmi = %{version}-%{release}
%description fish
Fish provides Shell, Extension/Plug-in and scripting interface. As a
shell, User has access to both in-band and out-of-band access to the
host BMC through a rich set of IPMI commands.

%package utils
Summary: FreeIPMI Utilities
Group: Application/Misc 
Requires: freeipmi = %{version}-%{release}
%description utils
FreeIPMI utilities ipmipower, bmc-watchdog, ipmiping, and rmcpping.

%if %{?_with_debug:1}%{!?_with_debug:0}
  %define _enable_debug --enable-debug --enable-trace --enable-syslog
%endif

%prep
%setup -q -n %{name}-%{version}

%build
%configure --program-prefix=%{?_program_prefix:%{_program_prefix}} \
           %{?_enable_debug}
make

%install
rm -rf $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT
DESTDIR="$RPM_BUILD_ROOT" make install
rm -f %{buildroot}%{_infodir}/dir

%clean
rm -rf $RPM_BUILD_ROOT

%post
if [ -x /sbin/install-info ]; then
   /sbin/install-info %{_infodir}/freeipmi.info.gz %{_infodir}/dir
fi

%preun
if [ $1 = 0 ]; then
   if [ -x /sbin/install-info ]; then
      /sbin/install-info --delete %{_infodir}/freeipmi.info.gz %{_infodir}/dir
   fi
fi

%post utils
%if %{?_with_bmc_watchdog_start:1}%{!?_with_bmc_watchdog_start:0}
#
# Start bmc-watchdog, but not by default
#
if [ "$1" = 1 ]; then
   if [ -x /etc/init.d/bmc-watchdog ]; then
      [ -x /sbin/chkconfig ] && /sbin/chkconfig --add bmc-watchdog
   fi
fi
if [ $1 -ge 1 ]; then
   if [ -x /etc/init.d/bmc-watchdog ]; then
      if /etc/init.d/bmc-watchdog status | grep -q running; then
         /etc/init.d/bmc-watchdog restart
      else
         /etc/init.d/bmc-watchdog start
      fi
   fi
fi
%endif
%if %{?_with_bmc_watchdog_condrestart:1}%{!?_with_bmc_watchdog_condrestart:0}
#
# Start bmc-watchdog if already running
#
if [ "$1" = 1 ]; then
   if [ -x /etc/init.d/bmc-watchdog ]; then
      [ -x /sbin/chkconfig ] && /sbin/chkconfig --add bmc-watchdog
   fi
fi
if [ $1 -ge 1 ]; then
   if [ -x /etc/init.d/bmc-watchdog ]; then
      /etc/init.d/bmc-watchdog condrestart
   fi
fi
%endif
%if %{?_with_powerman_restart:1}%{!?_with_powerman_restart:0}
#
# Restart powerman if it exists 
#
if [ -x /etc/init.d/powerman ]; then
    if /etc/init.d/powerman status | grep -q running; then
       /etc/init.d/powerman restart
    fi
fi
%endif

%preun utils
#
# Stop bmc-watchdog if it is running 
#
if [ "$1" = 0 ]; then
    if [ -x /etc/init.d/bmc-watchdog ]; then
       if /etc/init.d/bmc-watchdog status | grep -q running; then
          /etc/init.d/bmc-watchdog stop
       fi
       [ -x /sbin/chkconfig ] && /sbin/chkconfig --del bmc-watchdog
    fi
fi

%files
%defattr(-,root,root)
%doc %{_datadir}/doc/%{name}/AUTHORS
%doc %{_datadir}/doc/%{name}/BUGS
%doc %{_datadir}/doc/%{name}/COPYING
%doc %{_datadir}/doc/%{name}/ChangeLog
%doc %{_datadir}/doc/%{name}/INSTALL
%doc %{_datadir}/doc/%{name}/NEWS
%doc %{_datadir}/doc/%{name}/README
%doc %{_datadir}/doc/%{name}/THANKS
%doc %{_datadir}/doc/%{name}/TODO
%doc %{_datadir}/doc/%{name}/ipmi-over-ts2000.texi
%doc %{_infodir}/freeipmi.info*
%{_libdir}/*so*
/var/lib/*
 
%files devel
%defattr(-,root,root)
%doc %{_datadir}/doc/%{name}/examples/Makefile
%doc %{_datadir}/doc/%{name}/examples/ipmi-lan-test.c
%doc %{_datadir}/doc/%{name}/examples/ipmi-lan-test-udm.c
%doc %{_datadir}/doc/%{name}/freeipmi-hackers-intro.sxi
%doc %{_datadir}/doc/%{name}/ipmi-network-layout.fig
%{_libdir}/*.a
%{_libdir}/*.la
%{_includedir}/*

%files fish
%defattr(-,root,root)
%config(noreplace) %{_sysconfdir}/fish/fish.scm
%config(noreplace) %{_sysconfdir}/fish/ipmi-sensors-conf.scm
%{_sbindir}/fish
%{_sbindir}/bmc-config
%{_sbindir}/bmc-info
%{_sbindir}/ipmi-sel
%{_sbindir}/ipmi-sensors
%{_mandir}/man8/bmc-config.8*
%{_mandir}/man5/bmc-config.conf.5*
%{_mandir}/man8/bmc-info.8*
%{_mandir}/man8/fish.8*
%{_mandir}/man8/ipmi-sel.8*
%{_mandir}/man8/ipmi-sensors.8*
%{_datadir}/fish/*

%files utils
%defattr(-,root,root)
%doc %{_datadir}/doc/%{name}/COPYING.bmc-watchdog
%doc %{_datadir}/doc/%{name}/DISCLAIMER.bmc-watchdog
%doc %{_datadir}/doc/%{name}/COPYING.ipmiping
%doc %{_datadir}/doc/%{name}/DISCLAIMER.ipmiping
%doc %{_datadir}/doc/%{name}/COPYING.ipmipower
%doc %{_datadir}/doc/%{name}/DISCLAIMER.ipmipower
%doc %{_datadir}/doc/%{name}/COPYING.rmcpping
%doc %{_datadir}/doc/%{name}/DISCLAIMER.rmcpping
%config(noreplace) %{_sysconfdir}/init.d/bmc-watchdog
%config(noreplace) %{_sysconfdir}/garpd/garpd.conf
%{_sbindir}/bmc-watchdog
%{_sbindir}/ipmiping
%{_sbindir}/ipmipower
%{_sbindir}/rmcpping
%{_sbindir}/garpd
%{_mandir}/man5/ipmipower.conf.5*
%{_mandir}/man8/bmc-watchdog.8*
%{_mandir}/man8/ipmiping.8*
%{_mandir}/man8/ipmipower.8*
%{_mandir}/man8/rmcpping.8*
%{_mandir}/man8/garpd.8*
/var/log/*

%changelog
