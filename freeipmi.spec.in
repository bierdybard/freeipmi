#
# Copyright (c) 2003 FreeIPMI Core Team
#
%define name @PACKAGE@
%define version @VERSION@
%define release 1

Name: %{name}
Version: %{version}
Release: %{release}
License: GPL
Group: Development/System
Source: %{name}-%{version}.tar.gz
BuildRoot: /var/tmp/%{name}-%{version}
Summary: FreeIPMI
%description
The FreeIPMI project provides "Remote-Console" (out-of-band) and
"System Management Software" (in-band) based on Intelligent
Platform Management Interface (IPMI v1.5) specification.

%package devel
Summary: Development package for FreeIPMI
Group: Development/System
Requires: freeipmi = %{version}-%{release}
%description devel
Development package for FreeIPMI.  This package includes the FreeIPMI
header files and static libraries.

%package fish
Summary: FreeIPMI Shell
Group: Application/Misc  
Requires: freeipmi = %{version}-%{release}
%description fish
Fish provides Shell, Extension/Plug-in and scripting interface. As a
shell, User has access to both in-band and out-of-band access to the
host BMC through a rich set of IPMI commands.

%package utils
Summary: FreeIPMI Utilities
Group: Application/Misc 
Requires: freeipmi = %{version}-%{release}
%description utils
FreeIPMI utilities ipmipower, bmc-watchdog, ipmiping, and rmcpping.

%prep
%setup -q

%build
%configure --program-prefix=%{?_program_prefix:%{_program_prefix}}
make

%install
rm -rf $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT
DESTDIR="$RPM_BUILD_ROOT" make install

%clean
rm -rf $RPM_BUILD_ROOT

%post utils
%if %{?_with_bmc_watchdog_start:1}%{!?_with_bmc_watchdog_start:0}
#
# Start bmc-watchdog, but not by default
#
if [ "$1" = 1 ]; then
   if [ -x /etc/rc.d/init.d/bmc-watchdog ]; then
      [ -x /sbin/chkconfig ] && /sbin/chkconfig --add bmc-watchdog
   fi
fi
if [ $1 -ge 1 ]; then
   if [ -x /etc/rc.d/init.d/bmc-watchdog ]; then
      if /etc/rc.d/init.d/bmc-watchdog status | grep -q running; then
         /etc/rc.d/init.d/bmc-watchdog restart
      else
         /etc/rc.d/init.d/bmc-watchdog start
      fi
   fi
fi
%endif
%if %{?_with_bmc_watchdog_condrestart:1}%{!?_with_bmc_watchdog_condrestart:0}
#
# Start bmc-watchdog if already running
#
if [ "$1" = 1 ]; then
   if [ -x /etc/rc.d/init.d/bmc-watchdog ]; then
      [ -x /sbin/chkconfig ] && /sbin/chkconfig --add bmc-watchdog
   fi
fi
if [ $1 -ge 1 ]; then
   if [ -x /etc/rc.d/init.d/bmc-watchdog ]; then
      /etc/rc.d/init.d/bmc-watchdog condrestart
   fi
fi
%endif
%if %{?_with_powerman_restart:1}%{!?_with_powerman_restart:0}
#
# Restart powerman if it exists 
#
if [ -x /etc/rc.d/init.d/powerman ]; then
    if /etc/rc.d/init.d/powerman status | grep -q running; then
       /etc/rc.d/init.d/powerman restart
    fi
fi
%endif

%preun utils
#
# Stop bmc-watchdog if it is running 
#
if [ "$1" = 0 ]; then
    if [ -x /etc/rc.d/init.d/bmc-watchdog ]; then
       if /etc/rc.d/init.d/bmc-watchdog status | grep -q running; then
          /etc/rc.d/init.d/bmc-watchdog stop
       fi
       [ -x /sbin/chkconfig ] && /sbin/chkconfig --del bmc-watchdog
    fi
fi

%files
%defattr(-,root,root)
%doc /usr/share/doc/freeipmi/AUTHORS
%doc /usr/share/doc/freeipmi/BUGS
%doc /usr/share/doc/freeipmi/COPYING
%doc /usr/share/doc/freeipmi/ChangeLog
%doc /usr/share/doc/freeipmi/INSTALL
%doc /usr/share/doc/freeipmi/NEWS
%doc /usr/share/doc/freeipmi/README
%doc /usr/share/doc/freeipmi/TODO
%doc /usr/share/doc/freeipmi/authors.texi
%doc /usr/share/doc/freeipmi/fdl.texi
%doc /usr/share/doc/freeipmi/freeipmi.texi
%doc /usr/share/doc/freeipmi/gpl.texi
%doc /usr/share/doc/freeipmi/ipmi-over-ts2000.texi
%doc /usr/share/doc/freeipmi/permissions.texi
%doc /usr/share/doc/freeipmi/version.texi
%doc /usr/share/info/freeipmi.info*
%doc /usr/share/info/freeipmi.info-1*
%doc /usr/share/info/freeipmi.info-2*
%doc /usr/share/info/freeipmi.info-3*
%doc /usr/share/info/freeipmi.info-4*
%doc /usr/share/info/freeipmi.info-5*
/usr/lib/*so*
/var/lib/
 
%files devel
%defattr(-,root,root)
%doc /usr/share/doc/freeipmi/examples/Makefile
%doc /usr/share/doc/freeipmi/examples/hello-sensors.c
%doc /usr/share/doc/freeipmi/freeipmi-hackers-intro.sxi
%doc /usr/share/doc/freeipmi/ipmi-network-layout.fig
/usr/lib/*.a
/usr/lib/*.la
/usr/include

%files fish
%defattr(-,root,root)
%config(noreplace) /etc/fish/fish.scm
%config(noreplace) /etc/fish/sensors-conf.scm
/usr/sbin/fish
/usr/sbin/bmc-config
/usr/sbin/bmc-info
/usr/sbin/sel
/usr/sbin/sensors
/usr/share/fish
/usr/share/man/man1/bmc-config.1*
/usr/share/man/man1/bmc-info.1*
/usr/share/man/man1/fish.1*
/usr/share/man/man1/sel.1*
/usr/share/man/man1/sensors.1*

%files utils
%defattr(-,root,root)
%doc /usr/share/doc/freeipmi/COPYING.bmc-watchdog
%doc /usr/share/doc/freeipmi/DISCLAIMER.bmc-watchdog
%doc /usr/share/doc/freeipmi/COPYING.ipmiping
%doc /usr/share/doc/freeipmi/DISCLAIMER.ipmiping
%doc /usr/share/doc/freeipmi/COPYING.ipmipower
%doc /usr/share/doc/freeipmi/DISCLAIMER.ipmipower
%doc /usr/share/doc/freeipmi/COPYING.rmcpping
%doc /usr/share/doc/freeipmi/DISCLAIMER.rmcpping
%config(noreplace) /etc/init.d/bmc-watchdog
/usr/sbin/bmc-watchdog
/usr/sbin/ipmiping
/usr/sbin/ipmipower
/usr/sbin/rmcpping
/usr/share/man/man5/ipmipower.conf.5*
/usr/share/man/man8/bmc-watchdog.8*
/usr/share/man/man8/ipmiping.8*
/usr/share/man/man8/ipmipower.8*
/usr/share/man/man8/rmcpping.8*
/var/log/

%changelog
